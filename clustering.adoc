## Lab: Clustering Stateful Java EE Applications

### JBoss EAP のデプロイ


. カタログ選択
+
*Add to Project* &rarr; *Browse Catalog でカタログを表示します。
+
image::clustering-jbosseap-1.png[Catalog]
+
カタログから*Middleware* &rarr; *Runtimes & Frameworks* を選択し、JBoss EAP 7.0(no https) を選択します。
+
. ウィザード開始
+
* Information 画面
+
image::clustering-jbosseap-2.png[Wizard 1]
+
内容を確認して *Next* をクリックします。
+
. Configuration 画面
+
image::clustering-jbosseap-3.png[Wizard 2]
+
下記のパラメータを設定し、*Next* をクリックします。
+
|===
|パラメータ名|値|説明
|Add to Project|explore-XX|プロジェクトを選択します
|Application Name|eap-app|
|Git Repository URL|https://github.com/akubicharm/openshift-playground|
|Git Reference|master|
|Context Directory|app/session-replication/counter/dist
|===
+
. Binding 画面
+
image::clustering-jbosseap-4.png[Wizard 3]
+
*DO not bind at this time* を選択し、*Create* をクリックします


### JBoss EAP Clustering

JBoss EAP のクラスタリングは、他の jboss eap コンテナを検索し、クラスタを形成するための Kubernetes 検出メカニズムを使用して実現されます。これは、'standalone-openshift.xml' で JGroups プロトコルスタックを '<openshift KUBE_PING/>' 要素で構成することによって行われます。


`KUBE_PING` を動作させるには、次の手順を実行する必要があります。

. 'OPENSHIFT_KUBE_PING_NAMESPACE' 環境変数を設定する必要があります。設定されていない場合、サーバーは単一ノードのクラスタ ("1 つのクラスタ") として動作します。
.' OPENSHIFT_KUBE_PING_LABELS ' 環境変数を設定する必要があります。設定されていない場合、アプリケーションの外部の pod (ただし、名前空間にある) は参加しようとします。
. Kubernetes' REST api へのアクセスを許可するには、ポッドが実行されているサービスアカウントに権限を付与する必要があります。


ラボ環境は、Kubernetes' REST API にアクセスできるように、既定のサービスアカウントが既に構成されています。
これで、コンソール上の上矢印をクリックして、*JBoss EAP  * ポッドを2つにスケールアップすることができます。
または、コマンドラインを使用してポッドをスケールアップし、2つのメンバクラスタを形成することもできます。

[source]
----
$ oc scale dc/eap-app --replicas=2
----

JBoss EAP のPodは関連するJavaコンポーネントを表示するためのhawt.ioベースのJVMコンソールが利用できるようになっています。
Podが公開しているポートにjolokiaとう名前があるPodは、*Applications* &rarr; *Pods* の詳細画面に JVM コンソールを開くリンクが表示されています。
コンソールで eap-app のPodを選択し、*Details* タブに表示されている *Open Java Console* をクリックしてコンソールを開います。


image::clustering-details.png[Java Console Link,880,align="center"]

表示された *JMX* ブラウザで、*jgroups &rarr; チャンネル &rarr; ee* をクリックします。右ペインには、JMX 属性のクラスタリングのリストが表示されます。*view* には、現在のクラスタのステータスが表示されます。
属性には、クラスターのメンバーとなっている２つのPod名が表示されます。
*eap-app* のPodをスケールアップ/ダウンすると、JBoss EAP は KuberneteのAPIを経由して通知を受け、有効なPod数に基づいてクラスタのステータスを更新します。

image::clustering-hawtio.png[Java Console - Clustering,1000,align="center"]

// TODO: add stateful (session, cache, etc) data to the mlbparks backend.
