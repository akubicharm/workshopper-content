## Lab: Application Health

### Background: Readiness and Liveness Probes
OpenShift のアプリケーションのヘルスチェックの概念があります。これらの2つのフレーバーになる:

* Readiness probe
* Liveness probe


https://{{DOCS_URL}}/latest/dev_guide/application_health.html[Application Health] セクションでは、次の定義を参照してください。

[glossary]
Liveness Probe::

Liveness Probe は、構成されているコンテナがまだ実行されているかどうかをチェックします。Liveness Probe に障害が発生した場合、kubelet はコンテナを強制終了し、再起動ポリシーが実行されます。Pod 構成の `template.spec.containers.livenessprobe` を設定して、活性チェックをセットします。


Readiness Probe::

Readiness Probe は、コンテナーが要求をサービスする準備ができているかどうかを判断します。Readiness Probe がコンテナに障害が発生した場合、エンドポイントコントローラは、すべてのサービスのエンドポイントからその IP アドレスが削除されていることを確認します。準備プローブは、コンテナが実行されているにもかかわらず、プロキシからのトラフィックを受信しないことをエンドポイントコントローラに通知するために使用できます。 ポッド構成の `template.spec.containers.readinessprobe` を設定して、準備チェックをセットします。



web コンソールを使用して、これらの Probe を `nationalparks` アプリケーションに追加します。


### Exercise: Add Health Checks

我々は現実的な CI/CD のパイプラインを実装する予定ですので、アプリケーションの "開発" バージョンのいくつかのテストを行うことになります。ただし、テストするためには、アプリケーションの準備ができている必要があります。OpenShift のアプリケーションのヘルスチェック機能が非常に便利になる場所です。


既存の `nationalparks` DeploymentにとReadiness Probe を Liveness Probe の両方を追加していきます。これにより、OpenShift は、事前チェックに合格するまでサービスにインスタンスを追加せず、異常なインスタンスが再起動されることを保証します (Liveness チェックが失敗した場合)。


左側のバーにある *Applications* &rarr; *Deployments* をクリックします。`nationalparks` をクリックします。ヘルスチェックに関する警告が表示され、それらを追加するためのリンクがクリックされます。 *Add health checks* をクリックします。


あなたは両方をクリックしてください *Add Readiness Probe* と *Add Liveness Probe* をクリックし、し、パラメータを入力:

_Readiness Probe_

* Path: `/ws/healthz/`
* Initial Delay: `20`
* Timeout: `1`

image::pipeline-readiness.png[Readiness Probe]

_Liveness Probe_

* Path: `/ws/healthz/`
* Initial Delay: `120`
* Timeout: `1`

image::pipeline-liveness.png[Liveness Probe]


*Save* をクリックし、左側のナビゲーションの *Overview* ボタンをクリックします。これらの変更によって新しいデプロイが発生したことがわかります (構成の変更としてカウントされます)。


[silver]#You will also notice that the circle around the new deployment stays light blue for a while. This is a sign that the pod(s) have not yet passed their readiness checks -- it's working!#

また、Podの状態を表している丸が水色のままであることに気づくでしょう。これは、Pod(s) がの事前チャックチェックを通過していないというサインです。


image::apphealth-status.png[Application Health]
