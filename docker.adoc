## Lab: Deploy a Docker Image

OpenShift にアプリケーションをデプロイする方法の一つである、Docker Image を指定したアプリケーションのデプロイを実行します。

image::docker-component-diagram.png[Parksmap Component Diagram]
 

### Application description
// In this lab, we're going to deploy the web component of the ParksMap application which is also called `parksmap` and uses OpenShift service discovery mechanism to discover the backend services deployed and shows their data on the map.

この演習では、`parksmap` とも呼ばれますが、OpenShift サービス検索バックエンド サービスを検出するためのメカニズムを展開し、マップ上のデータを示していますを使用して、ParksMap アプリケーションの web コンポーネントを配置していきます。

image::roadshow-app-architecture-parksmap-1.png[Application architecture,800,align="center"]

### Exercise: Deploying your first Image

// Let's start by doing the simplest thing possible - get a plain old Docker-formatted image to run on OpenShift. This is incredibly simple to do.  With {{OPENSHIFT_NAME}} {{OPENSHIFT_VERSION}} it can be done directly from the web console.

できるだけ簡単なことを行うことから始めましょう。Docker 形式のイメージを取得してOpenShiftで実行します。これは非常に簡単です。 {{OPENSHIFT_NAME}} {{OPENSHIFT_VERSION}} を使用すると、web コンソールから直接実行できます。

// [silver]#Return to the web console:#

Web コンソールに戻ります。

*link:https://{{CONSOLE_ADDRESS}}[]*

// [silver]#Find your *{{EXPLORE_PROJECT_NAME}}{{USER_SUFFIX}}* project and click it. Next, click "Add to project" at the top of the screen.#

*{{EXPLORE_PROJECT_NAME}}{{USER_SUFFIX}}* プロジェクトを見つけてクリックします。次に、画面の上部にある "Add to project" をクリックします。

// [silver]#There are several options, but we are only concerned with "Deploy Image". Click it. We will learn more about image streams and image stream tags later. For now, select the "Image Name" option, and copy/paste the following into the box:#

ここではいくつかのオプションがありますが、"Deploy Image" をクリックします。"Image Name" オプションを選択し、次の文字列を copy/pasteします。

[source]
----
docker.io/openshiftroadshow/{{PARKSMAP_IMAGENAME}}:{{PARKSMAP_VERSION}}
----

// [silver]#Your screen will end up looking something like this:#

画面はこんな感じになります。　

image::parksmap-image.png[Explore Project]

// [silver]#Either press *enter* or click on the magnifying glass. OpenShift will then go out to the Docker registry specified and interrogate the image. You then are presented with some options to add things like environment variables, labels, and etc. -- which we will learn about later.#

虫眼鏡のボタンををクリックします。openshift は、指定された Docker レジストリからイメージを取得します。その後、環境変数、ラベルなどを追加するいくつかのオプションが表示されます。 

{% if PARKSMAP_PY %}

// [silver]#For now, change the application name:#

今回はアプリケーションの名前だけ変更します。

image::parksmap-image-options.png[Explore Project]

{% endif %}

// [silver]#Hit the blue "Create" button at the bottom of the screen and then click the "Continue to overview" link. Take a moment to look at the various messages that you now see on the overview page.#

画面の下部にある青色の "Create" ボタンをクリックし、"Continue to overview" リンクを押します。Overview ページに表示されるさまざまなメッセージを見てみましょう。

// [silver]#WINNING! These few steps are the only ones you need to run to get a "vanilla" Docker-formatted image deployed on OpenShift. This should work with any
Docker-formatted image that follows best practices, such as defining an EXPOSE port, not needing to run specifically as the *root user* or other user name, and a single non-exiting CMD to execute on start.#

これらのいくつかの手順は、作成済みのDocker形式のイメージを取得してOpenShiftに展開するための手順です。これは、すべての docker では、公開ポートの定義、*root user* または他のユーザー名として実行する必要がなく、開始後に実行される1つの非終了 CMD など、ベストプラクティスに従ったイメージがフォーマットされています。

たった数ステップで、既存のDockerイメージからOpenShift上にアプリケーションがデプロイできます。次の条件を満たすコンテナイメージならばこの方式が利用できます。
EXPOSE ポートが定義されていること。rootユーザのような特定のユーザで実行しないこと、単一で起動後にexitしないCMDが指定されていること。


```
FROM jboss/base-jdk:8

MAINTAINER Erik Jacobs <erikmjacobs@gmail.com>

COPY parksmap-web.jar /parksmap.jar
CMD java -jar /parksmap.jar
EXPOSE 8080
```

### Background: Containers and Pods

// [silver]#Before we start digging in we need to understand how containers and *Pods* are related. Given the morning sessions where we discussed the OpenShift platform and how it uses containers and *Pods*, we will not be covering the background on these technologies in this lab.  Instead, we will dive right in and start using them.#

コンテナとPodの関係を、デプロイ済みの環境を使って掘り下げていきましょう

// [silver]#In OpenShift, the smallest deployable unit is a *Pod*. A *Pod* is a group of one or more Docker containers deployed together and guaranteed to be on the same host.  From the doc:#

OpenShift では、デプロイ可能な最小単位は *Pod* です。*Pod* は、1つまたは複数の docker コンテナをまとめて配置し、同じホスト上にあることが保証されたグループです。 


ドキュメントからの引用
[source]
----
Each pod has its own IP address, therefore owning its entire port space, and containers within pods can share storage. Pods can be "tagged" with one or more labels, which are then used to select and manage groups of pods in a single operation.

各ポッドには独自の IP アドレスがあるため、ポート空間全体が所有され、pod 内のコンテナはストレージを共有できます。pod は1つまたは複数のラベルで "タグ付け" することができ、1つの操作でポッドのグループを選択して管理するために使用されます。
----

// [silver]#*Pods* can contain multiple Docker instances. The general idea is for a Pod to contain a "server" and any auxiliary services you want to run along with that server. Examples of containers you might put in a *Pod* are, an Apache HTTPD server, a log analyzer, and a file service to help manage uploaded files.#

*Pod* には複数の docker インスタンスを含めることができます。一般的なアイデアは、"サーバー" とそのサーバーと一緒に実行する任意の補助サービスを一つのPodに含むようにしています。*Pod* に入れられるコンテナの例としては、apache httpd サーバ、ログアナライザ、アップロードしたファイルの管理に役立つファイルサービスなどがあります。

image::docker-PodServiceRoute.png[Pod Service Route]

### Exercise: Examining the Pod

// [silver]#In the web console's overview page you will see that there is a single *Pod* that was created by your actions. This *Pod* contains a single container, which happens to be the parks map application - a simple Spring Boot/Java application.#

web コンソールの概要ページには、先ほど作成した1つの *Pod* が表示されています。この *Pod* には公園の場所を表示する地図アプリケーションの1つコンテナが含まれています。アプリケーションは、シンプルな Spring Boot/Java アプリケーションです。


// [silver]#You can also examine *Pods* from the command line:#

CLI を使って、Podの情報を確認することができます。


[source]
----
$ oc get pod
----

// [silver]#You should see output that looks similar to:#

次のような出力が表示されます。


[source]
----
NAME               READY     STATUS    RESTARTS   AGE
parksmap-1-hx0kv   1/1       Running   0          2m
----

// [silver]#The above output lists all of the *Pods* in the current *Project*, including the *Pod* name, state, restarts, and uptime. Once you have a *Pod*'s name, you can get more information about the *Pod* using the *oc get* command.  To make the output readable, I suggest changing the output type to *YAML* using the following syntax:#

上記の出力には、*Pods* の名前、状態、再起動回数、稼働時間など、現在の *Project* 内のすべての *Pod* が一覧表示されます。 *Pod* の名前がわかれば、"oc get" コマンド を使用して *Pod* についての詳細情報を得ることができます。 出力を読みやすくするために、次の構文を使用して出力の種類を *YAML* に変更することをお勧めします。


[NOTE]
====
// [silver]#Make sure you use the correct *Pod* name from your output.#

*Pod* 名が正しいことを確認してください。
====


[source,role=copypaste]
----
$ oc get pod parksmap-1-hx0kv -o yaml
----

// [silver]#You should see something like the following output (which has been truncated due to space considerations of this workshop manual):#

次の出力のようなものが表示されます。


[source]
----
apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubernetes.io/created-by: |
      {"kind":"SerializedReference","apiVersion":"v1","reference":{"kind":"ReplicationController","namespace":"explore-00","name":"parksmap-1","uid":"f1b37b1b-e3e2-11e6-81a2-0696d1181070","apiVersion":"v1","reso
urceVersion":"36222"}}
    kubernetes.io/limit-ranger: 'LimitRanger plugin set: cpu, memory request for container
      parksmap; cpu, memory limit for container parksmap'
    openshift.io/deployment-config.latest-version: "1"
    openshift.io/deployment-config.name: parksmap
    openshift.io/deployment.name: parksmap-1
    openshift.io/generated-by: OpenShiftWebConsole
    openshift.io/scc: restricted
  creationTimestamp: 2017-01-26T16:17:36Z
  generateName: parksmap-1-
  labels:
    app: parksmap
    deployment: parksmap-1
    deploymentconfig: parksmap
  name: parksmap-1-bvaz6
...............
----

// [silver]#The web interface also shows a lot of the same information on the *Pod* details page. If you click in the *Pod* circle, and then click the *Pod* name, you will find the details page. You can also get there by clicking "Applications", then "Pods", at the left, and then clicking the *Pod* name.#

web インターフェイスには、*Pod* の詳細ページに情報が多数表示されます。*Pod* の円をクリックし、*Pod* 名をクリックすると、詳細ページが表示されます。また、そこから "Applications" をクリックして取得することができます, 次に *Pod* 名をクリックします。

// [silver]#Getting the parks map image running may take a little while to complete. Each OpenShift node that is asked to run the image has to pull (download) it if the node does not already have it cached locally. You can check on the status of the image download and deployment in the *Pod* details page, or from the command line with the `oc get pods` command that you used before.#

Parksmap アプリケーションが実行されるまでには、少しかかる場合があります。Podを稼働させる各 OpenShift ノードは、コンテナイメージがローカルにキャッシュされていない場合は、それをダウンロード(Docker Pull)する必要があります。 Webコンソールの *Pod* の詳細ページまてゃ `oc get pod` コマンドで、イメージのダウンロードとデプロイの状況を確認することができます。


### Background: A Little About the Docker Daemon

// [silver]#Whenever OpenShift asks the node's Docker daemon to run an image, the Docker daemon will check to make sure it has the right "version" of the image to run.  If it doesn't, it will pull it from the specified registry.#

OpenShift が、ノードの docker デーモンにコンテナの実行を要求するたびに、docker デーモンは正しいバージョンのコンテナイメージがあることを確認します。ない場合には、指定されたレジストリからダウンロードします。

// [silver]#There are a number of ways to customize this behavior. They are documented in https://{{DOCS_URL}}/latest/dev_guide/application_lifecycle/new_app.html#specifying-an-image[specifying an image] as well as https://{{DOCS_URL}}/latest/dev_guide/managing_images.html#image-pull-policy[image pullpolicy].#

イメージの取得ポリシーをカスタマイズする方法のは幾つかあります。

|===
|Always|毎回イメージをpullする
|IfNotPresent|イメージがない場合だけpullする
|Never|イメージをpullしない（あらかじめdocker pullでキャッシュしておく必要がある）
|===

詳細はマニュアルに記載しています。
https://{{DOCS_URL}}/latest/dev_guide/application_lifecycle/new_app.html#specifying-an-image[specifying an image]
同様に
https://{{DOCS_URL}}/latest/dev_guide/managing_images.html#image-pull-policy[image pullpolicy]。


#### Background: Services

// [silver]#*Services* provide a convenient abstraction layer inside OpenShift to find a group of like *Pods*. They also act as an internal proxy/load balancer between those *Pods* and anything else that needs to access them from inside the OpenShift environment. For example, if you needed more parks map servers to handle the load, you could spin up more *Pods*. OpenShift automatically maps them as endpoints to the *Service*, and the incoming requests would not notice anything different except　that the *Service* was now doing a better job handling the requests.#

*Service* は、Podをグルーピングしてアクセスするための抽象的なレイヤを提供します。また、OpenShift 内で *Pod* へアクセスする場合の Proxy /Load Balancer としての機能も提供します。たとえば、高負荷の処理するために多くの Parksmap アプリケーションが必要な場合は、*Pod* をスケールアップすることができます。OpenShift は、自動的に追加されたPodをエンドポイントとして *Service* にマッピングし、処理を割りするようになるので。

// [silver]#When you asked OpenShift to run the image, it automatically created a *Service* for you. Remember that services are an internal construct. They are not available to the "outside world", or anything that is outside the OpenShift environment. That's OK, as you will learn later.#

OpenShift にイメージを実行するように要求すると、自動的に *Service* が作成されます。サービスは内部構造であることに注意してください。Servicesは、"外の世界"、または OpenShift 環境の外にあるものには利用できません。

// [silver]#The way that a *Service* maps to a set of *Pods* is via a system of *Labels* and *Selectors*. *Services* are assigned a fixed IP address and many ports and protocols can be mapped.#

*Service* を *Pod* と関連づける方法は、*Labels* と *Selectors* のシステムを介しています。*Services* は、固定 IP アドレスが割り当てられている多くのポートとプロトコルをマップすることができます。

// [silver]#There is a lot more information about https://{{DOCS_URL}}/latest/architecture/core_concepts/pods_and_services.html#services[Services], including the YAML format to make one by hand, in the official documentation.#

Pod とサービスの詳細はマニュアルを参照してください。
https://{{DOCS_URL}}/latest/architecture/core_concepts/pods_and_services.html#services[Services]


// [silver]#Now that we understand the basics of what a *Service* is, let's take a look at the *Service* that was created for the image that we just deployed.  In order to view the *Services* defined in your *Project*, enter in the following command:#

先ほどデプロイした Pod の Service を確認します。*Project* ないの *Service* の一覧は、次のコマンドで取得します。

[source]
----
$ oc get services
----

// [silver]#You should see output similar to the following:#

次のような出力が表示されます。


[source]
----
NAME       CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
parksmap   172.30.169.213   <none>        8080/TCP   3h
----

// [silver]#In the above output, we can see that we have a *Service* named `parksmap` with an IP/Port combination of 172.30.169.213/8080TCP. Your IP address may be different, as each *Service* receives a unique IP address upon creation. *Service* IPs are fixed and never change for the life of the *Service*.#

上記の出力では、我々は 172.30.169.213/8080TCP のIP/Port の組み合わせで `parksmap` という名前の *Service* を持っていることがわかります。各 *Service* は、作成時に一意の IP アドレスを設定されるので、IP アドレスが上記のサンプルとは異なる場合があります。*Service* IPs は固定されており、*Service* の有効な間は変更することはありません。

// [silver]#In the web console, service information is available by clicking "Applications" and then clicking "Services" in the "Networking" submenu.#

web コンソールでは、「Applications」 をクリックし、「Networking」 サブメニューの「Services」 をクリックして、サービス情報を表示できます。

// [silver]#You can also get more detailed information about a *Service* by using the following command to display the data in YAML:#

また、次のコマンドを使用して YAML でデータを表示することにより、*Service* に関する詳細な情報を取得することもできます。


[source]
----
$ oc get service parksmap -o yaml
----

// [silver]#You should see output similar to the following:#

次のような出力が表示されます。


[source]
----
apiVersion: v1
kind: Service
metadata:
  annotations:
    openshift.io/generated-by: OpenShiftWebConsole
  creationTimestamp: 2016-10-03T15:33:17Z
  labels:
    app: parksmap
  name: parksmap
  namespace: {{EXPLORE_PROJECT_NAME}}{{USER_SUFFIX}}
  resourceVersion: "6893"
  selfLink: /api/v1/namespaces/{{EXPLORE_PROJECT_NAME}}{{USER_SUFFIX}}/services/parksmap
  uid: b51260a9-897e-11e6-bdaa-2cc2602f8794
spec:
  clusterIP: 172.30.169.213
  ports:
  - name: 8080-tcp
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    deploymentconfig: parksmap
  sessionAffinity: None
  type: ClusterIP
status:
  loadBalancer: {}
----

// [silver]#Take note of the `selector` stanza. Remember it.#

`selector` の記述を覚えていてください。


// [silver]#It is also of interest to view the JSON of the *Pod* to understand how OpenShift wires components together.  For example, run the following command to get the name of your `parksmap` *Pod*:#

OpenShiftがどのようにコンポーネントを関連づけているかを理解するために、興味のある *Pod* の JSON を表示することができます。 たとえば、次のコマンドを実行して、`parksmap` *Pod* の名前を取得します。

[source]
----
$ oc get pods
----

// [silver]#You should see output similar to the following:#

次のような出力が表示されます。


[source]
----
NAME               READY     STATUS    RESTARTS   AGE
parksmap-1-hx0kv   1/1       Running   0          3h
----

// [silver]#Now you can view the detailed data for your *Pod* with the following command:#

次のコマンドで *Pod* の詳細データを表示することができます。


[source]
----
$ oc get pod parksmap-1-hx0kv -o yaml
----

// [silver]#Under the `metadata` section you should see the following:#

`metadata` セクションの下で、次を確認します。

[source]
----
labels:
  app: parksmap
  deployment: parksmap-1
  deploymentconfig: parksmap
----

// * [silver]#The *Service* has `selector` stanza that refers to `deploymentconfig=parksmap`.#
// * [silver]#The *Pod* has multiple *Labels*:#
// ** [silver]#`deploymentconfig=parksmap`#
// ** [silver]#`app=parksmap`#
// ** [silver]#`deployment=parksmap-1`#

* *Service* には `selector` として `deploymentconfig = parksmap` が定義されている
* *Pod* は複数 *Labels*　がある
** `deploymentconfig=parksmap`
** `app=parksmap`
** `deployment=parksmap-1`


//[silver]#*Labels* are just key/value pairs. Any *Pod* in this *Project* that has a *Label* that matches the *Selector* will be associated with the *Service*. To see this in action, issue the following command:#

*Labels* は単なるkey/value ペアだけです。 *Selector* にマッチする *Label* を持つ *Project* 内の任意の*Pod* が、*Service*に 関連づけられます。確認するには、次のコマンドを実行します。

[source]
----
$ oc describe service parksmap
----

// [silver]#You should see something like the following output:#

次のように表示されます。

[source]
----
Name:                   parksmap
Namespace:              {{EXPLORE_PROJECT_NAME}}{{USER_SUFFIX}}
Labels:                 app=parksmap
Selector:               deploymentconfig=parksmap
Type:                   ClusterIP
IP:                     172.30.169.213
Port:                   8080-tcp        8080/TCP
Endpoints:              10.1.2.5:8080
Session Affinity:       None
No events.
----

// [silver]#You may be wondering why only one end point is listed. That is because there is only one *Pod* currently running.  In the next lab, we will learn how to scale an application, at which point you will be able to see multiple endpoints associated with the *Service*.#

Endpoints には、Service と関連付けられた Pod のIPアドレスが一つだけ記載されていまう。Pod をスケールアップすると、記載されるIPアドレスもふえます。
