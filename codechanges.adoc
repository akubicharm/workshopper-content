## Lab: Making Code Changes and using webhooks

### Background: Web Hooks

ほとんどの Git リポジトリサーバーは web フックの概念をサポートしています -- コードリポジトリの変更が発生したときに HTTP(S) を介して外部ソースwを呼び出します。 OpenShift は、ビルドをトリガーするためにリモートシステムからフックを受け取ることをサポートする API エンドポイントを提供します。OpenShift API でコード・リポジトリーのフックをポイントすることで、自動化されたcode/build/deploy パイプラインを実現できます。


{% if GIT_HOST == "github" %}
`
#### Getting the webhook URL

**Builds** -> **Builds** -> **Configuration**  に移動すると **Triggers** セクションがあります。そこに表示されている **Github webhook URL** をコピーして、Github の Webhook に設定します。

#### Setting up the webhook

**Github** リポジトリページを開き、**Settings** タブに移動して、左側のメニューで **Webhooks** に進みます。**Add webhook** をクリックしてフォームを埋める。

*** **Payload URL** は OpenShift からコピーされた url です。
*** **Content type** は、*application/json* でなければなりません
*** **Secret** は空にする必要があります
*** **Disable SSL verification** クラスタに有効な SSL 証明書がないため
**Add webhook**をクリックします。

#### Making a code change

同じリポジトリ内の **Code** タブに戻り、**wsgi.py** ファイルを開きます。右上隅のペンアイコンをクリックして、ファイルを編集します。
`35` 行めに移動し、**displayName**を変更します。
ページの一番下までスクロールし、**Commit changes** をクリックします。

#### Validation on OpenShift

{% else %}

#### Exercise: Configuring GitLab Web Hooks

{% if modules.pipelines %}

以前のラボでは、CI/CD パイプラインを作成して、`nationalparks` アプリケーションのビルド、テスト、および展開を自動化しました。この演習では、pipline webhook を使用して、`nationalparks` GitLab リポジトリに変更があるたびにパイプライン実行をトリガすることができます。OpenShift web コンソールで、`{{EXPLORE_PROJECT_NAME}}{{USER_SUFFIX}}` *Project* に移動し、マウスの上にある *Browse* および *Pipelines* をクリックします。`nationalparks-pipeline` をクリックし、*Configuration* タブを選択します。


この画面では、次の図に示すように、*generic* web URL をコピーするオプションが表示されます。

image::ocp-webhook1-pipeline.png[Webhook]
{% else %}
OpenShift web コンソールで、`{{EXPLORE_PROJECT_NAME}}{{USER_SUFFIX}}` *Project* に移動し、マウスの上にある *Browse* をクリックしてから *Builds* します。`nationalparks`ビルドをクリックします。


この画面では、次の図に示すように、*generic* web URL をコピーするオプションが表示されます。

image::ocp-webhook1.png[Webhook]
{% endif %}


URL をクリップボードにコピーしたら、ローカルの GitLab にあるコードリポジトリに移動します。

[source,role=copypaste]
----
{% if PARKSMAP_PY %}
http://{{GITLAB_URL_OPENTLC}}/{{GITLAB_USER}}/nationalparks-py/tree/{{NATIONALPARKS_VERSION}}
{% else %}
http://{{GITLAB_URL_OPENTLC}}/{{GITLAB_USER}}/nationalparks
{% endif %}
----

[NOTE]
====
この GitLab インスタンスの資格情報は次のとおりです。

Username: {{GITLAB_USER}}

Password: {{GITLAB_PASSWORD}}
====



画面右上の Settingsリンクをクリックし、左側のメニューからWebhooks を選択します。
Add Webhook ボタンをクリックします。

image::ocp-webhook2.png[Webhook]

次の画面で、"Payload URL" フィールドに、コピーしておいたOpenShift の Generic Web Hook リンクを貼り付けます。secret toke フィールドは空白のままにしておくことができます--シークレットは既に URL にあり、ペイロード内にある必要はありません。


image::ocp-webhook3.png[Webhook]

ページの一番下までスクロールします。SSL 確認チェックボックスをオフにしてください。OpenShift の API は、既知/信頼された機関によって署名した SSL 証明書を提示していないことに注意してください。チェックを外し忘れるとwebhook は失敗します。

最後に、"Add webhook" をクリックしてください。

image::ocp-webhook4.png[Webhook]

準備ができました!これからは、新しいソースコードを GitLab リポジトリにコミットするたびに、OpenShift の内部で新しいビルドとデプロイが行われます。 これを試してみましょう。


#### Exercise: Using GitLab Web Hooks

{% if PARKSMAP_PY %}

git リポジトリの適切なタグに戻るようにしてください。

*link:http://{{GITLAB_URL_OPENTLC}}/{{GITLAB_USER}}/nationalparks-py/tree/{{NATIONALPARKS_VERSION}}[]*

GitLab ページの上部にある"プロジェクト"をクリックし、ページの中央の"ファイル"を確認します。これは GitLab のリポジトリビューです。右上のドロップダウンメニューが `1.0.0` ブランチに設定されていることを確認します。ルートパスに移動し、`wsgi.py` ファイルをクリックします。

画面にファイルが表示されたら、次のように右上隅の編集ボタンをクリックします。

image::ocp-webhook5-py.png[Webhook]


変更行番号 35:

[source]
----
'displayName': 'National Parks (PY)'
----


変更後

[source]
----
'displayName': 'World National Parks (PY)'
----

{% else %}

GitLab ページの上部にある"プロジェクト"をクリックし、ページの中央にあるファイルを確認します。これは GitLab のリポジトリビューです。右上のドロップダウンメニューが `{{NATIONALPARKS_VERSION}}` 分岐に設定されていることを確認します。次のパスに移動します。


[source]
----
src/main/java/com/openshift/evg/roadshow/parks/rest/
----


`BackendController.java`　ファイルをクリックします。


画面にファイルが表示されたら、次のように右上隅の 編集ボタンをクリックします。

image::ocp-webhook5.png[Webhook]


行番号20を変更します。

[source]
----
return new Backend("nationalparks","National Parks", new Coordinates("47.039304", "14.505178"), 4);
----


変更後

[source]
----
return new Backend("nationalparks","OpenShift National Parks", new Coordinates("47.039304", "14.505178"), 4);
----

{% endif %}

画面の下部にある"変更をコミット"をクリックします。お気軽にコミットメッセージを入力してください。


{% endif %}

{% if modules.pipelines %}


あなたの変更をコミットしたら、`nationalparks-pipeline` は、ほぼ瞬時に OpenShift でトリガされる必要があります。パイプラインが実行されていることを確認するには、OpenShift コンソールの *Builds* &rarr; *Pipelines* ページを参照してください。


image::ocp-webhook6-pipeline.png[Pipeline Running]


テスト段階の後、パイプラインは、*Live* コンテナに展開するために手動承認を待機します。*Input Required* リンクをクリックしてください。そのリンクは展開を承認するために Jenkins のコンソールが開くので、*Proceed* ボタンをクリックしてください。


image::pipeline-jenkins-input.png[Pipline Manual Approval,1000,align=center]


パイプラインの実行が完了したら、ブラウザでアプリケーションを表示して、新しい Docker イメージが自動的に展開されたことを確認します。

{% else %}

あなたの変更をコミットしたら、*Build* は、ほぼ瞬時に OpenShift でトリガされる必要があります。web コンソールの *Build* ページを参照するか、次のコマンドを実行して確認します。


[source]
----
$ oc get builds
----


新しいビルドが実行されていることがわかります。

[source]
----
NAME              TYPE      FROM          STATUS     STARTED          DURATION
nationalparks-1   Source    Git@b052ae6   Complete   18 hours ago     36s
nationalparks-2   Source    Git@3b26e1a   Running    43 seconds ago
----

ビルドと展開が完了したら、ブラウザーでアプリケーションを表示して、新しい Docker イメージが自動的に展開されたことを確認します。
{% endif %}


[source,role=copypaste]
----
http://nationalparks{% if modules.pipelines %}-live{% endif %}-{{EXPLORE_PROJECT_NAME}}{{USER_SUFFIX}}.{{ROUTER_ADDRESS}}/ws/info/
----


これで、返された JSON 文字列に設定した新しい名前が表示されます。

[NOTE]
====
マップの凡例自体でこれを表示するには、parksmap を0に縮小してから1にバックアップし、アプリがキャッシュを更新するように強制する必要があります。
====


#### Exercise: Rollback

OpenShift を使用すると、毎回再構築する必要なく、アプリケーションの異なるバージョン間を移動できます。アプリケーションのすべてのバージョン (過去のビルド) は、OpenShift レジストリに Docker 形式のイメージとして存在します。`oc rollback`と`oc deploy`コマンドを使用すると、さまざまなバージョンのアプリケーション間を移動または転送することができます。


ロールバックを実行するには、アプリケーションをデプロイした *Deployment Config* の名前を知っておく必要があります。

[source]
----
$ oc get dc
----

// TODO: Need non-pipeline version

出力は次のようになります。

[source]
----
NAME                 REVISION   DESIRED   CURRENT   TRIGGERED BY
mongodb              1          1         1         config,image(mongodb:3.2)
parksmap             2          1         1         config,image(parksmap:{{PARKSMAP_VERSION}})
nationalparks        9          1         1         {% if modules.pipelines %}config{% else %}config,image(nationalparks:latest){% endif %}
{% if modules.pipelines %}
jenkins              1          1         1         config,image(jenkins:latest)
mongodb-live         1          1         1         config,image(mongodb:3.2)
nationalparks-live   4          1         1         config,image(nationalparks:live)
{% endif %}
----

次のコマンドを実行して、最新のコード変更をロールバックします。

[source]
----
$ oc rollback nationalparks{% if modules.pipelines %}-live{% endif %}
----


次のような出力が表示されます。

[source]
----
#5 rolled back to nationalparks{% if modules.pipelines %}-live{% endif %}-3
Warning: the following images triggers were disabled: nationalparks:live
  You can re-enable them with: oc set triggers dc/nationalparks{% if modules.pipelines %}-live{% endif %} --auto
----


デプロイが完了したら、ブラウザでアプリケーションを表示して、ページヘッダーが元のヘッダーに戻されることを確認します。

[source,role=copypaste]
----
http://nationalparks{% if modules.pipelines %}-live{% endif %}-{{EXPLORE_PROJECT_NAME}}{{USER_SUFFIX}}.{{ROUTER_ADDRESS}}/ws/info/
----

[NOTE]
====
ロールバックの一部として新しいイメージの自動展開は無効になり、rollback の完了後すぐに不要な展開を防ぐことができます。自動展開を再度有効にするには、次のように実行します。
====


[source]
----
$ oc set triggers dc/nationalparks{% if modules.pipelines %}-live{% endif %} --auto
----


#### Exercise: Rollforward

// TODO: Fix deployment numbers

ロールバックを実行した場合と同じように、同じコマンドを使用してロールフォワードを実行することもできます。あなたは、*ロールバック* を要求したときに、それは新しい展開 (#3) を引き起こしたことに気づくでしょう。本質的には、我々は常に転送 OpenShift でも、我々は "戻る" つもりで移動します。

{% if modules.pipelines %}
* 最初のデプロイメント (#1) が初期定義であることがわかっています。
* 我々は、2番目の展開 (#2) 私たちの configmap の追加によるものであることを知っている。
* 我々は、3番目の展開 (#3) は、パイプラインの我々の最初の実行されたことを知っている。
* 我々は、4番目の展開 (#4) 私たちの変更されたことを知っている "OpenShift 国立
* 5 番目の展開 (#5) は「国立公園」へのロールバックだったことを知っています。
{% endif %}


したがって、"新しいコード" バージョンに戻りたい場合は、配置 #4 ます。

[source]
----
$ oc rollback nationalparks{% if modules.pipelines %}-live{% endif %}-4
----

次のように表示されます。

[source]
----
#6 rolled back to nationalparks{% if modules.pipelines %}-live{% endif %}-4
Warning: the following images triggers were disabled: nationalparks:live
  You can re-enable them with: oc set triggers dc/nationalparks{% if modules.pipelines %}-live{% endif %} --auto
----


クール! *ロールバック* が完了したら、あなたは再び "OpenShift National Parks" を参照してください確認してください。
